var exec = require('child_process').exec;
var parseurl = require('url');

var DEFAULT_PATH = '/misc';
var map = false;

function misc(mapper) {
    map = mapper;
    return misc.express;
}

misc.express = function(req,res,next) {
    if (req.path.indexOf(DEFAULT_PATH) === 0) {
        //replace + and decode
        path = decodeURIComponent(req.path.replace(/\+/g, ' '));
            //remove leading and trailing /
            path = path.replace(/^\/|\/$/g,'');
            //split and remove leading path
            var parts = path.split('/');
            parts.shift();
            var command = parts.shift();
            console.log('executing',command,parts);
            if (misc[command]) {
                if (command === 'start') {
                    misc.start();
                } else {
                misc[command].apply(this,parts);
            }
            //prevent anything else from being served from this subpath
            res.end('executed '+command);
            return;
        }
    }
    next();
};

misc.start = function() {
    cb();

    function cb() {
    }
};

misc.sendKey = function(key) {
    if ( key == 'textme' ) {
        exec('gvapi -n 17047371123 -m CodeFinished!');
    } else {
        exec('misc_control.sh ' + key);
    }
};

misc.mapKey = function(command,key,then) {
    misc[command] = function() {
        misc.sendKey(key);
        if (then) {
            then();
        }
    };
};

misc.mapKey('rumcoke','rumcoke');
misc.mapKey('gintonic','gintonic');
misc.mapKey('textme','textme');
misc.mapKey('kill','kill');
misc.mapKey('garage','garage');
module.exports = misc;
